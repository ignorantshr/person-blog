
[TOC]
# 哨兵机制

Redis 在 2.8 版本以后提供的`哨兵（Sentinel）机制`，它的作用是**实现主从节点故障转移**。它会监测主节点是否存活，如果发现主节点挂了，它就会选举一个从节点切换为主节点，并且把新主节点的相关信息通知给从节点和客户端。

补充文章：

- [官方 sentinel 文档](https://redis.io/docs/management/sentinel/)

## 工作原理

哨兵其实是一个运行在特殊模式下的 Redis 进程，所以它也是一个节点。它相当于是“观察者节点”，观察的对象是主从节点。

哨兵节点主要负责三件事情：监控、选主、通知。

## 判断故障节点

哨兵会每隔 1 秒给所有主从节点发送 `PING 命令`，当主从节点收到 PING 命令后，会发送一个响应命令给哨兵，这样就可以判断它们是否在正常运行。

![](https://camo.githubusercontent.com/44693bb1ae02f565936b2a761f6d8f5ffe4ebe21331bac22fcbbb79a11d45022/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f32366638383337336438343534363832623965306331643466643136313162342e706e67)

如果主节点或者从节点没有在规定的时间内响应哨兵的 PING 命令，哨兵就会将它们标记为**主观下线**。这个「规定的时间」是配置项 `down-after-milliseconds `参数设定的，单位是毫秒。

**针对「主节点」有「主观下线」和「客观下线」两个状态**，是因为有可能「主节点」其实并没有故障，可能只是因为主节点的系统压力比较大或者网络发送了拥塞，导致主节点没有在规定时间内响应哨兵的 PING 命令。

所以，为了减少误判的情况，哨兵在部署的时候不会只部署一个节点，而是用多个节点部署成**哨兵集群（最少需要三台机器来部署哨兵集群），通过多个哨兵节点一起判断，就可以就可以避免单个哨兵因为自身网络状况不好，而误判主节点下线的情况**。同时，多个哨兵的网络同时不稳定的概率较小，由它们一起做决策，误判率也能降低。

当一个哨兵判断主节点为「主观下线」后，就会向其他哨兵发起`is-master-down-by-addr`命令，其他哨兵收到这个命令后，就会根据自身和主节点的网络状况，做出赞成投票或者拒绝投票的响应。
![](https://camo.githubusercontent.com/c534e43d3376ae3a7e82c6562cb30b9736cad64d432c59d680a6da6abdc334ea/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f31336534333631343037626134363937396538303265616136353464636636372e706e67)

当这个哨兵的赞同票数达到哨兵配置文件中的 quorum 配置项设定的值后，这时**主节点就会被该哨兵标记为「客观下线」**。quorum 的值一般设置为哨兵个数的二分之一加 1。

哨兵判断完主节点客观下线后，哨兵就要开始在多个「从节点」中，选出一个从节点来做新主节点。

## 哨兵 leader 选举

哨兵集群需要选出一个 leader，让 leader 来执行主从切换。

哪个哨兵节点判断主节点为「客观下线」，这个哨兵节点就是候选者，所谓的候选者就是想当 Leader 的哨兵。

候选者会向其他哨兵发送命令，表明希望成为 Leader 来执行主从切换，并让所有其他哨兵对它进行投票。

**每个哨兵只有一次投票机会**，如果用完后就不能参与投票了，可以投给自己或投给别人，但是只有候选者才能把票投给自己。

那么在投票过程中，任何一个「候选者」成为 leader 要满足两个条件：

- 第一，拿到半数以上的赞成票；
- 第二，拿到的票数同时还需要大于等于哨兵配置文件中的 quorum 值。

**哨兵节点至少要有 3 个，而且哨兵节点的数量应该是奇数**。

## 主从故障转移的过程

在哨兵集群中通过投票的方式，选举出了哨兵 leader 后，就可以进行主从故障转移的过程了，如下图：

![](https://camo.githubusercontent.com/7e8bd8850e5a4100db8782ec710d833928a140f3cdb952cf4236c491065985e2/68747470733a2f2f63646e2e7869616f6c696e636f64696e672e636f6d2f67682f7869616f6c696e636f6465722f72656469732f2545352539332541382545352538352542352f2545342542382542422545342542422538452545362539352538352545392539412539432545382542442541432545372541372542422e706e67)

主从故障转移操作包含以下四个步骤：

1. 在已下线主节点（旧主节点）属下的所有「从节点」里面，挑选出一个从节点，并将其转换为主节点。
1. 让已下线主节点属下的所有「从节点」修改复制目标，修改为复制「新主节点」；
1. 将新主节点的 IP 地址和信息，通过「发布者/订阅者机制」通知给客户端；
1. 继续监视旧主节点，当这个旧主节点重新上线时，将它设置为新主节点的从节点；

### 1. 选出新主节点

在已下线主节点属下的所有「从节点」中，挑选出一个状态良好、数据完整的从节点，然后向这个「从节点」发送 `REPLICAOF no one` 命令，将这个「从节点」转换为「主节点」。

**首先要把网络状态不好的从节点给过滤掉**。首先把已经下线的从节点过滤掉，然后把以往网络连接状态不好的从节点也给过滤掉。

> 怎么判断从节点之前的网络连接状态好不好?
	Redis 有个叫 `down-after-milliseconds * 10` 配置项，其 down-after-milliseconds 是主从节点断连的最大连接超时时间。如果在 down-after-milliseconds 毫秒内，主从节点都没有通过网络联系上，我们就可以认为主从节点断连了。如果发生断连的次数超过了 10 次，就说明这个从节点的网络状况不好，不适合作为新主节点。

过滤之后 ，接下来要对所有从节点进行三轮考察：**优先级、复制进度、ID 号**。在进行每一轮考察的时候，哪个从节点优先胜出，就选择其作为新主节点。

- 第一轮考察：哨兵首先会根据从节点的优先级来进行排序，优先级越小排名越靠前，
- 第二轮考察：如果优先级相同，则查看复制的下标，哪个从「主节点」接收的复制数据多，哪个就靠前。
- 第三轮考察：如果优先级和下标都相同，就选择从节点 ID 较小的那个。

**第一轮考察：优先级最高的从节点胜出**

Redis 有个叫 `slave-priority` 配置项，可以给从节点设置优先级。

每一台从节点的服务器配置不一定是相同的，我们可以根据服务器性能配置来设置从节点的优先级。

**第二轮考察：复制进度最靠前的从节点胜出**

如果在第一轮考察中，发现优先级最高的从节点有两个，那么就会进行第二轮考察，比较两个从节点哪个复制进度。

如果某个从节点的 slave_repl_offset 最接近 master_repl_offset，说明它的复制进度是最靠前的，于是就可以将它选为新主节点。

**第三轮考察：ID 号小的从节点胜出**

如果在第二轮考察中，发现有两个从节点优先级和复制进度都是一样的，那么就会进行第三轮考察，比较两个从节点的 ID 号，ID 号小的从节点胜出。

在选举出从节点后，哨兵 leader 向被选中的从节点发送 REPLICAOF no one 命令，让这个从节点解除从节点的身份，将其变为新主节点。

### 2. 将从节点指向新主节点

当新主节点出现之后，哨兵 leader 下一步要做的就是，让已下线主节点属下的所有「从节点」指向「新主节点」，这一动作可以通过向「从节点」发送 SLAVEOF 命令来实现。


### 3. 通知客户的主节点已更换

新主节点的信息通知给客户端是通过 Redis 的**发布者/订阅者机制来实现的**。每个哨兵节点提供发布者/订阅者机制，客户端可以从哨兵订阅消息。

哨兵提供的消息订阅频道有很多，不同频道包含了主从节点切换过程中的不同关键事件，几个常见的事件如下：
![](https://camo.githubusercontent.com/c824d6eb99d55eace2323927d86a95cb744f96f6330e21910e192a52863dafbf/68747470733a2f2f63646e2e7869616f6c696e636f64696e672e636f6d2f67682f7869616f6c696e636f6465722f72656469732f2545352539332541382545352538352542352f2545352539332541382545352538352542352545392541322539312545392538312539332e77656270)

客户端和哨兵建立连接后，客户端会订阅哨兵提供的频道。主从切换完成后，哨兵就会向 `+switch-master` 频道发布新主节点的 IP 地址和端口的消息，这个时候客户端就可以收到这条信息，然后用这里面的新主节点的 IP 地址和端口进行通信了。


### 4. 将旧主节点变为从节点

故障转移操作最后要做的是，继续监视旧主节点，当旧主节点重新上线时，哨兵集群就会向它发送 `REPLICAOF` 命令，让它成为新主节点的从节点。

## 哨兵集群是如何组成

在配置哨兵的信息时，只需要填下面这几个参数，设置主节点名字、主节点的 IP 地址和端口号以及 quorum 值。
```
sentinel monitor <master-name> <ip> <redis-port> <quorum> 
```

**哨兵节点之间是通过 Redis 的发布者/订阅者机制来相互发现的**。

在主从集群中，主节点上有一个名为`__sentinel__:hello` 的频道，不同哨兵就是通过它来相互发现，实现互相通信的。

![](https://camo.githubusercontent.com/d9192f2ffd62fc2ee73565ecb7173badaad1a58c0f1cb011f2b4953de3490202/68747470733a2f2f696d672d626c6f672e6373646e696d672e636e2f61363238363035336336383834636635386266333937643031363734666538302e706e67)

主节点知道所有「从节点」的信息，所以哨兵会每 10 秒一次的频率向主节点发送 INFO 命令来获取所有「从节点」的信息。

接着，哨兵就可以根据从节点列表中的连接信息，和每个从节点建立连接，并在这个连接上持续地对从节点进行监控。

